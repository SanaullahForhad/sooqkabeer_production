<!DOCTYPE html>
<html lang="{{ current_lang }}" dir="{% if current_lang == 'ar' %}rtl{% else %}ltr{% endif %}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Layout Control - سوق كبير</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #4a6491);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        h1 { font-size: 2em; margin-bottom: 10px; }
        
        .back-btn {
            display: inline-block;
            margin-top: 15px;
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            text-decoration: none;
            border-radius: 6px;
            transition: all 0.3s;
        }
        
        .back-btn:hover { background: rgba(255,255,255,0.3); }
        
        .nav {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .nav a {
            padding: 12px 24px;
            background: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .nav a:hover { background: #2980b9; }
        .nav a.active { background: #2c3e50; }
        
        /* Layout Controls */
        .control-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        
        .section-title {
            font-size: 1.4em;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .section-list {
            display: grid;
            gap: 15px;
        }
        
        .section-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            transition: all 0.3s;
        }
        
        .section-item:hover {
            background: #e9f7fe;
            border-color: #3498db;
        }
        
        .section-drag {
            cursor: move;
            margin: 0 15px;
            color: #7f8c8d;
            font-size: 1.2em;
        }
        
        .section-toggle {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
            margin: 0 15px;
        }
        
        .section-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #4CAF50;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        
        .section-name {
            flex: 1;
            font-weight: 500;
            color: #2c3e50;
        }
        
        .section-order {
            width: 60px;
            text-align: center;
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }
        
        /* Categories */
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .category-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .category-name {
            font-weight: 500;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        /* Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 1em;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #4CAF50;
            color: white;
        }
        
        .btn-primary:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        /* Status Messages */
        .status-message {
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            display: none;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-sliders-h"></i> Homepage Layout Control</h1>
            <p>Enable/disable sections and set display order</p>
            <a href="/admin/dashboard" class="back-btn"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
        </div>
        
        <div class="nav">
            <a href="/admin/dashboard">Dashboard</a>
            <a href="/admin/vendors">Vendors</a>
            <a href="/admin/products">Products</a>
            <a href="/admin/layout" class="active">Layout Control</a>
            <a href="/admin/settings">Settings</a>
        </div>
        
        <!-- Sections Control -->
        <div class="control-section">
            <h2 class="section-title"><i class="fas fa-th-large"></i> Page Sections</h2>
            <p style="color: #666; margin-bottom: 20px;">Drag to reorder, toggle to enable/disable sections</p>
            
            <div class="section-list" id="sectionsList">
                {% for section in layout_settings %}
                <div class="section-item" data-section="{{ section[1] }}">
                    <div class="section-drag">
                        <i class="fas fa-grip-vertical"></i>
                    </div>
                    
                    <label class="section-toggle">
                        <input type="checkbox" class="section-enable" 
                               {% if section[3] %}checked{% endif %}
                               data-section="{{ section[1] }}">
                        <span class="toggle-slider"></span>
                    </label>
                    
                    <div class="section-name">
                        {{ section[2] }}
                        <div style="font-size: 0.9em; color: #7f8c8d; margin-top: 3px;">
                            ID: {{ section[1] }}
                        </div>
                    </div>
                    
                    <input type="number" class="section-order" value="{{ section[4] }}" 
                           min="1" max="20" data-section="{{ section[1] }}">
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Categories Priority -->
        <div class="control-section">
            <h2 class="section-title"><i class="fas fa-list-ol"></i> Categories Display Order</h2>
            <p style="color: #666; margin-bottom: 20px;">Set priority order for categories on homepage</p>
            
            <div class="categories-grid" id="categoriesList">
                {% for category in categories %}
                <div class="category-item">
                    <div class="category-name">
                        <i class="fas fa-tag"></i> 
                        {{ category[1] }}
                        <div style="font-size: 0.9em; color: #7f8c8d; margin-top: 3px;">
                            ID: {{ category[0] }}
                        </div>
                    </div>
                    
                    <div style="margin-top: 10px;">
                        <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <input type="checkbox" class="category-active" 
                                   {% if category[6] %}checked{% endif %}
                                   data-category="{{ category[0] }}">
                            <span>Show on homepage</span>
                        </label>
                        
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span>Order:</span>
                            <input type="number" class="category-order" 
                                   value="{{ category[5] }}" min="1" max="50"
                                   data-category="{{ category[0] }}" 
                                   style="width: 70px; padding: 5px;">
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Status Message -->
        <div id="statusMessage" class="status-message"></div>
        
        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="saveLayout()">
                <i class="fas fa-save"></i> Save Changes
            </button>
            <button class="btn btn-secondary" onclick="resetToDefault()">
                <i class="fas fa-undo"></i> Reset to Default
            </button>
            <button class="btn btn-secondary" onclick="previewChanges()">
                <i class="fas fa-eye"></i> Preview Homepage
            </button>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
    <script>
        // Initialize drag and drop for sections
        const sectionsList = document.getElementById('sectionsList');
        Sortable.create(sectionsList, {
            animation: 150,
            ghostClass: 'sortable-ghost',
            onEnd: function() {
                updateSectionOrders();
            }
        });
        
        // Update section order numbers after drag
        function updateSectionOrders() {
            const items = sectionsList.querySelectorAll('.section-item');
            items.forEach((item, index) => {
                const orderInput = item.querySelector('.section-order');
                orderInput.value = index + 1;
            });
        }
        
        // Collect all layout data
        function collectLayoutData() {
            const sections = [];
            const categories = [];
            
            // Collect section data
            document.querySelectorAll('.section-item').forEach(item => {
                const sectionName = item.getAttribute('data-section');
                const enabled = item.querySelector('.section-enable').checked;
                const order = parseInt(item.querySelector('.section-order').value);
                
                sections.push({
                    name: sectionName,
                    enabled: enabled,
                    order: order
                });
            });
            
            // Collect category data
            document.querySelectorAll('.category-item').forEach(item => {
                const categoryId = item.querySelector('.category-active').getAttribute('data-category');
                const active = item.querySelector('.category-active').checked;
                const order = parseInt(item.querySelector('.category-order').value);
                
                categories.push({
                    id: parseInt(categoryId),
                    active: active,
                    order: order
                });
            });
            
            return { sections, categories };
        }
        
        // Save layout changes
        async function saveLayout() {
            const data = collectLayoutData();
            const statusDiv = document.getElementById('statusMessage');
            
            try {
                const response = await fetch('/admin/layout/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    statusDiv.className = 'status-message status-success';
                    statusDiv.innerHTML = `
                        <i class="fas fa-check-circle"></i> 
                        ${result.message} 
                        <span style="float: right;">${new Date().toLocaleTimeString()}</span>
                    `;
                    statusDiv.style.display = 'block';
                    
                    // Hide message after 3 seconds
                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                    }, 3000);
                } else {
                    throw new Error(result.error || 'Unknown error');
                }
            } catch (error) {
                statusDiv.className = 'status-message status-error';
                statusDiv.innerHTML = `
                    <i class="fas fa-exclamation-circle"></i> 
                    Error: ${error.message}
                `;
                statusDiv.style.display = 'block';
            }
        }
        
        // Reset to default
        function resetToDefault() {
            if (confirm('Are you sure you want to reset all layout settings to default?')) {
                // Reset section orders and enables
                document.querySelectorAll('.section-enable').forEach((checkbox, index) => {
                    checkbox.checked = index < 5; // First 5 enabled by default
                });
                
                document.querySelectorAll('.section-order').forEach((input, index) => {
                    input.value = index + 1;
                });
                
                // Reset categories
                document.querySelectorAll('.category-active').forEach(checkbox => {
                    checkbox.checked = true;
                });
                
                document.querySelectorAll('.category-order').forEach((input, index) => {
                    input.value = index + 1;
                });
                
                alert('Reset to default values. Click "Save Changes" to apply.');
            }
        }
        
        // Preview homepage
        function previewChanges() {
            window.open('/', '_blank');
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Layout control loaded');
        });
    </script>
</body>
</html>
