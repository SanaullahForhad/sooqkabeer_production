# fix_categories.py
import sqlite3
import os

def fix_categories():
    db_path = 'sooqkabeer.db'
    
    if not os.path.exists(db_path):
        print(f"âŒ Database file not found: {db_path}")
        return
    
    conn = sqlite3.connect(db_path)
    cursor = conn.cursor()
    
    print("ğŸ“ Fixing categories table...")
    
    # 1. Create categories table if not exists
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS categories (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name_en TEXT NOT NULL,
            name_ar TEXT NOT NULL,
            description TEXT,
            parent_id INTEGER DEFAULT NULL,
            icon TEXT,
            image TEXT,
            sort_order INTEGER DEFAULT 0,
            status TEXT DEFAULT 'active',
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    # 2. Check if table has any data
    cursor.execute("SELECT COUNT(*) FROM categories")
    count = cursor.fetchone()[0]
    
    if count == 0:
        print("ğŸ“ Adding default categories...")
        # Add default categories
        default_cats = [
            (1, 'Groceries', 'Ø§Ù„Ø¨Ù‚Ø§Ù„Ø©', 'Food and grocery items', None, 1),
            (2, 'Electronics', 'Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª', 'Electronic devices', None, 2),
            (3, 'Clothing', 'Ù…Ù„Ø§Ø¨Ø³', 'Clothing items', None, 3),
            (4, 'Home & Kitchen', 'Ø§Ù„Ù…Ù†Ø²Ù„ ÙˆØ§Ù„Ù…Ø·Ø¨Ø®', 'Home products', None, 4),
            (5, 'Fruits', 'ÙÙˆØ§ÙƒÙ‡', 'Fresh fruits', 1, 1),
            (6, 'Vegetables', 'Ø®Ø¶Ø±ÙˆØ§Øª', 'Fresh vegetables', 1, 2),
            (7, 'Mobile Phones', 'Ù‡ÙˆØ§ØªÙ Ù…Ø­Ù…ÙˆÙ„Ø©', 'Smartphones', 2, 1),
            (8, 'Laptops', 'Ø£Ø¬Ù‡Ø²Ø© ÙƒÙ…Ø¨ÙŠÙˆØªØ± Ù…Ø­Ù…ÙˆÙ„Ø©', 'Laptops', 2, 2),
            (9, 'Men\'s Clothing', 'Ù…Ù„Ø§Ø¨Ø³ Ø±Ø¬Ø§Ù„ÙŠØ©', 'Men fashion', 3, 1),
            (10, 'Women\'s Clothing', 'Ù…Ù„Ø§Ø¨Ø³ Ù†Ø³Ø§Ø¦ÙŠØ©', 'Women fashion', 3, 2)
        ]
        
        for cat_id, name_en, name_ar, desc, parent_id, sort_order in default_cats:
            cursor.execute('''
                INSERT OR REPLACE INTO categories 
                (id, name_en, name_ar, description, parent_id, sort_order, created_at)
                VALUES (?, ?, ?, ?, ?, ?, datetime('now'))
            ''', (cat_id, name_en, name_ar, desc, parent_id, sort_order))
        
        print(f"âœ… Added {len(default_cats)} default categories")
    
    # 3. Commit changes
    conn.commit()
    
    # 4. Verify
    cursor.execute("SELECT COUNT(*) FROM categories")
    final_count = cursor.fetchone()[0]
    
    cursor.execute("SELECT id, name_en, name_ar FROM categories ORDER BY sort_order")
    categories = cursor.fetchall()
    
    print(f"\nğŸ“Š Categories in database: {final_count}")
    print("ğŸ“‹ Category list:")
    for cat in categories:
        print(f"  {cat[0]}: {cat[1]} / {cat[2]}")
    
    conn.close()
    
    print(f"\nâœ… Categories table fixed successfully!")
    print("ğŸ”„ Now you can access /vendor/add_product")

if __name__ == "__main__":
    fix_categories()
