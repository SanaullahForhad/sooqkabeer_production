from flask import Flask, render_template, request, redirect, session
import sqlite3
import os
from datetime import datetime

app = Flask(__name__)
app.secret_key = 'sooqkabeer-kuwait-2024-secret'
app.config['DATABASE'] = 'sooqkabeer.db'
app.config['TEMPLATES_AUTO_RELOAD'] = True

def get_db():
    conn = sqlite3.connect(app.config['DATABASE'])
    conn.row_factory = sqlite3.Row
    return conn

def init_db():
    conn = get_db()
    cursor = conn.cursor()
    
    # à¦à¦¡à¦®à¦¿à¦¨ à¦Ÿà§‡à¦¬à¦¿à¦²
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS admin (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            username TEXT UNIQUE NOT NULL,
            password TEXT NOT NULL,
            email TEXT UNIQUE NOT NULL
        )
    ''')
    
    # à¦­à§‡à¦¨à§à¦¡à¦° à¦Ÿà§‡à¦¬à¦¿à¦²
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS vendor (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            vendor_code TEXT UNIQUE NOT NULL,
            name TEXT NOT NULL,
            email TEXT UNIQUE NOT NULL,
            phone TEXT NOT NULL,
            status TEXT DEFAULT 'Active',
            commission_rate REAL DEFAULT 10.0
        )
    ''')
    
    # à¦¡à¦¿à¦«à¦²à§à¦Ÿ à¦à¦¡à¦®à¦¿à¦¨ à¦¯à§‹à¦— à¦•à¦°à§à¦¨
    cursor.execute("SELECT * FROM admin WHERE username='admin'")
    if not cursor.fetchone():
        cursor.execute(
            "INSERT INTO admin (username, password, email) VALUES (?, ?, ?)",
            ('admin', 'admin123', 'admin@sooqkabeer.com')
        )
    
    # à¦¡à§‡à¦®à§‹ à¦­à§‡à¦¨à§à¦¡à¦° à¦¯à§‹à¦— à¦•à¦°à§à¦¨
    cursor.execute("SELECT * FROM vendor")
    if not cursor.fetchone():
        vendors = [
            ('HKO-001', 'Ø£Ø­Ù…Ø¯ Ø³ØªÙˆØ±', 'ahmed@sooqkabeer.com', '12345678', 'Active', 10.0),
            ('HKO-002', 'Ø±Ø­Ù…Ø§Ù† ØªØ±Ø§Ø¯Ø±Ø²', 'rahman@sooqkabeer.com', '87654321', 'Active', 10.0)
        ]
        cursor.executemany(
            "INSERT INTO vendor (vendor_code, name, email, phone, status, commission_rate) VALUES (?, ?, ?, ?, ?, ?)",
            vendors
        )
    
    conn.commit()
    conn.close()

# à¦¹à§‹à¦®à¦ªà§‡à¦œ à¦°à¦¾à¦‰à¦Ÿ
@app.route('/')
def home():
    return render_template('index.html')

# à¦­à§‡à¦¨à§à¦¡à¦° à¦ªà§‡à¦‡à¦œ
@app.route('/vendors')
def vendors():
    conn = get_db()
    vendors = conn.execute('SELECT * FROM vendor WHERE status="Active"').fetchall()
    conn.close()
    return render_template('vendors.html', vendors=vendors)

# à¦…à§à¦¯à¦¾à¦¡à¦®à¦¿à¦¨ à¦²à¦—à¦¿à¦¨
@app.route('/admin/login', methods=['GET', 'POST'])
def admin_login():
    if request.method == 'POST':
        username = request.form.get('username')
        password = request.form.get('password')
        
        if username == 'admin' and password == 'admin123':
            session['admin_logged_in'] = True
            session['admin_username'] = username
            return redirect('/admin/dashboard')
    
    return render_template('admin/login.html')

# à¦…à§à¦¯à¦¾à¦¡à¦®à¦¿à¦¨ à¦¡à§à¦¯à¦¾à¦¶à¦¬à§‹à¦°à§à¦¡
@app.route('/admin/dashboard')
def admin_dashboard():
    if not session.get('admin_logged_in'):
        return redirect('/admin/login')
    
    conn = get_db()
    total_vendors = conn.execute('SELECT COUNT(*) FROM vendor').fetchone()[0]
    total_orders = conn.execute('SELECT COUNT(*) FROM orders').fetchone()[0] if 'orders' in [table[0] for table in conn.execute("SELECT name FROM sqlite_master WHERE type='table'").fetchall()] else 0
    conn.close()
    
    return render_template('admin/dashboard.html',
                         total_vendors=total_vendors,
                         total_orders=total_orders,
                         total_products=0,
                         recent_orders=[])

# à¦…à¦¨à§à¦¯à¦¾à¦¨à§à¦¯ à¦…à§à¦¯à¦¾à¦¡à¦®à¦¿à¦¨ à¦ªà§‡à¦‡à¦œ
@app.route('/admin/vendors')
def admin_vendors():
    if not session.get('admin_logged_in'):
        return redirect('/admin/login')
    conn = get_db()
    vendors = conn.execute('SELECT * FROM vendor').fetchall()
    conn.close()
    return render_template('admin/vendors.html', vendors=vendors)

@app.route('/admin/commissions')
def admin_commissions():
    if not session.get('admin_logged_in'):
        return redirect('/admin/login')
    return render_template('admin/commissions.html')

@app.route('/admin/products')
def admin_products():
    if not session.get('admin_logged_in'):
        return redirect('/admin/login')
    return render_template('admin/products.html')

@app.route('/admin/users')
def admin_users():
    if not session.get('admin_logged_in'):
        return redirect('/admin/login')
    return render_template('admin/users.html')

@app.route('/admin/logout')
def admin_logout():
    session.clear()
    return redirect('/admin/login')

if __name__ == '__main__':
    print("=" * 60)
    print("Ø³ÙˆÙ‚ ÙƒØ¨ÙŠØ± Ø§Ù„ÙƒÙˆÙŠØª - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ")
    print("=" * 60)
    print("ğŸŒ Ø§Ù„Ù…ÙˆÙ‚Ø¹: http://127.0.0.1:8080")
    print("ğŸ‘¨â€ğŸ’¼ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…: http://127.0.0.1:8080/admin/login")
    print("ğŸ”‘ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: admin")
    print("ğŸ”‘ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: admin123")
    print("=" * 60)
    
    # à¦¡à¦¾à¦Ÿà¦¾à¦¬à§‡à¦¸ à¦‡à¦¨à¦¿à¦¶à¦¿à¦¯à¦¼à¦¾à¦²à¦¾à¦‡à¦œ
    init_db()
    
    # à¦¸à¦¾à¦°à§à¦­à¦¾à¦° à¦šà¦¾à¦²à§
    app.run(host='0.0.0.0', port=8080, debug=True)
